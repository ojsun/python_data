############################################
머신러닝에서 사용하는 모델들 : ARIMA, SARIMAX 모델을 가장 많이 사용
############################################

< 지수평활 (Exponential Smoothing) >
지수평활(Exponential Smoothing) 은 시계열 데이터 분석에서 일반적으로 사용되는 기법 중 하나이다. 이는 데이터의 패턴을 예측하는 데 도움이 되는, 데이터의 노이즈를 줄이고 추세를 더 잘 파악 할 수 있는 방법이다.

지수평활의 기본적인 아이디어는 최근의 관찰값에 더 많은 가중치 를 주고, 과거의 관찰값에는 적은 가중치 를 주는 것이다. ‘지수’라는 용어는 각 관찰값에 곱해지는 가중치가 지수적으로 감소하기 때문에 사용된다.

## 이 방법은 다음과 같은 이유로 사용된다:

* 간단함: 지수평활은 계산이 간단하고 이해하기 쉬운 방법이다. 이는 데이터가 복잡한 패턴이나 추세를 보이지 않을 때 특히 유용하다
* 노이즈 감소: 지수평활은 원래의 시계열 데이터에서 노이즈를 줄이고 주요한 패턴을 강조함으로써 데이터를 더 잘 이해하는 데 도움이 된다.
* 예측: 지수평활은 미래 값의 예측에 사용할 수 있다. 이 방법은 과거의 데이터를 사용하여 미래의 데이터를 예측하는 방법 중 하나로, 데이터의 패턴이 시간이 지남에 따라 일정하게 유지될 것으로 예상되는 경우 특히 유용하다
* 빠른 업데이트: 지수평활은 새로운 데이터가 추가될 때마다 쉽게 업데이트될 수 있다. 이는 특히 실시간 분석이 필요한 경우에 유용하다

### 지수평활에는 다양한 변형이 있다.

* 가장 간단한 형태의 지수평활은 단순 지수평활(Simple Exponential Smoothing, SES)이며, 이는 데이터에 선형적인 패턴이 없을 때 사용된다.
* 더 복잡한 형태의 지수평활은 홀트의 선형 지수평활(Holt's Linear Exponential Smoothing) 이나 홀트-윈터스의 계절적 지수평활(Holt-Winters' Seasonal Exponential Smoothing) 과 같이 트렌드와 계절성을 포함하는 데이터를 다룰 수 있다.

## 활용
data.ewm(alpha=0.1).mean()  
# ewm 지수가중함수(클수록 변화에 민감/적을수록 평활),알파값이 적을수록 노이즈값 제어
# 추가 메서드 mean() 지수가중평균 


<이동평균(Moving Average)>
이동 평균은 주어진 시점에서 이전 n 개의 데이터 포인트의 평균을 계산 하는 것을 의미하다
이는 시계열 데이터의 잡음을 줄이고 데이터의 기본적인 패턴을 확인하는 데 도움이 된다.

## 이동평균(moving average) 를 구하는 방식
# 초반 데이터가 없을때 10일땐 10일, 30일은 30일의 자료가 있어야 분석가능

(예시)  * 10일 이동평균을 계산
        data.rolling(window=10).mean().bfill()  # bfill() 결측치가 바로 아랫값으로 채워짐


< 정상성(stationary) / 비정상성(non-stationary)>
1. 정상 시계열 (stationary)
정상 시계열은 시간의 흐름에 따라 그 통계적 특성이 변하지 않는 시계열 을 의미하다
다시 말해, 정상 시계열의 평균과 분산(또는 표준편차), 그리고 공분산은 시간이 변해도 일정 하다
이러한 특성 때문에 정상 시계열은 분석이 용이하며, 많은 통계적 시계열 모델들(AR, MA, ARMA 등)은 데이터가 정상성을 가정 하고 있다. (여기서, 정상성을 가정한다는 점이 매우 중요하다!!)

(예시)
* 시간에 따른 일정한 주기를 가진 신호(일정한 주기로 진동하는 심장 박동)
* 백색 잡음(랜덤한 값들의 연속) 등이 있다.

2. 비정상 시계열 (non-stationary)
비정상 시계열은 시간의 흐름에 따라 그 통계적 특성이 변하는 시계열 을 의미하다 즉, 평균, 분산, 공분산 등이 시간에 따라 변화하다
비정상 시계열 데이터는 시간의 흐름에 따라 통계적 속성이 변하는 데이터를 의미하다 이는 추세(trend) 또는 계절성(seasonality) 때문에 발생할 수 있다.

# 추세(trend): 시계열 데이터가 시간에 따라 증가하거나 감소하는 경향 을 보일 때, 이를 추세 라고 하다
# 계절성(seasonality): 시계열 데이터가 일정한 주기로 반복되는 패턴 을 보일 때, 이를 계절성 이라고 하다
# 대부분의 실제 시계열 데이터는 비정상적인 성질을 가지고 있다. 이 경우에는 데이터를 정상적으로 만드는 변환(예: 차분, 로그 변환 등) 이 필요할 수 있다.
(예시)
* 시간에 따라 트렌드가 있는 주가 데이터
* 인구 증가 데이터 등
-->이러한 데이터는 시간에 따라 평균과 분산이 변하기 때문에 비정상적(non-stationary) 이다.

3. 정상성(stationary) / 비정상성(non-stationary) 확인
1)시각화를 통한 확인
 ACF(Auto Correlation Function) Plot - 시각화
 https://www.statsmodels.org/stable/generated/statsmodels.graphics.tsaplots.plot_acf.html

2) 분석 tip 1. 통계적 유의성 확인
* 자기 상관이 통계적으로 유의미한지 여부를 나타내는 “신뢰구간”을 회색 음영 영역(shading area) 으로 표시
* 기본적으로 95% 신뢰구간 을 사용하여 shading area를 그린다.
* 각 Lag 에서 Shading 영역을 벗어나 자기상관계수(Autocorrelation) 추정치는 95% 신뢰구간을 벗어났기 때문에, 통계적 유의성을 찾을 수 없다 는 의미로 해석할 수 있다

3) 분석 tip 2. 정상성 확인
* 보통은 시차가 커질수록 상관계수는 점차 0에 가까워지며, 시차가 커질 수록 자기상관성이 떨어지는 양상을 보여주는 것이 일반적이다. 하지만, Seasonal 한 데이터의 경우, 값이 다시 튀어오르는 현상은 있을 수 있다.

* ACF는 시계열 데이터의 정상성을 판단할 때 유용 하게 활용될 수 있다.
    * 빠르게 0으로 수렴하는 경우 -> 정상(stationary) 시계열, 천천히 감소한다.
    * 큰 상관계수를 가지는 경우 비정상(non-stationary) 시계열 데이터로 평가할 수 있다.
* ACF는 시계열 데이터의 lagged 복사본과 원본 사이의 상관 관계를 측정한다.

## PACF(Partial Autocorrelation Function) Plot - 시각화
* 시간차(lag)가 늘어나면서 관측치 간의 상관 관계가 어떻게 변하는지 설명 한다.
* 원리적으로, PACF는 선형 회귀분석을 통해 계산된다. 각 시차의 관측치를 이전 시차들의 관측치로 선형 회귀분석 하고, 이때의 회귀 계수를 PACF로 간주한다. 이렇게 하면, PACF는 이전 시차들의 영향을 배제하고 특정 시차만의 자기상관을 측정할 수 있다.

분석 tip 1. AR 모델의 차수 결정
* PACF를 사용하면 AR 모델의 차수 를 결정하는 데 도움이 될 수 있다.
* PACF는 다른 모든 시점의 영향을 배제하고 두 시점 사이의 상관 관계를 측정한다.

## 정상성 검증 :
1) kpss test
* 귀무가설: 해당 시계열은 정상(stationary) 시계열이다. <-> 대립가설: 해당 시계열은 비정상(non-stationary) 시계열이다.
    * p-value <= 0.05 : 귀무가설 기각/ 대립가설 채택 -> 비정상(non-stationary) 시계열.
    * p-value > 0.05 : 귀무가설 채택/ 대립가설 기각 -> 정상(stationary) 시계열.

2) Adfuller 테스트 
kpss test 와 귀무가설이 반대이다. (이걸 쓰도록)

* 귀무가설: 해당 시계열은 비정상(non-stationary) 시계열이다. <-> 대립가설: 해당 시계열은 정상(stationary) 시계열이다.
    * p-value <= 0.05 : 귀무가설 기각/ 대립가설 채택 -> 정상(stationary) 시계열.
    * p-value > 0.05 : 귀무가설 채택/ 대립가설 기각 -> 비정상(non-stationary) 시계열.

< ARIMA Model >
시계열 데이터 분석에서는 AR(AutoRegressive), MA(Moving Average), ARMA(AutoRegressive Moving Average), ARIMA(AutoRegressive Integrated Moving Average) 등의 모델이 있다.

* AR (AutoRegressive): 이전 관측치의 값들이 현재 관측치에 영향을 주는 모델이다. 예를 들어, AR(1) 모델은 현재 관측치가 바로 이전 관측치에 의해 영향을 받는다는 것을 나타냅니다. AR 모델은 파라미터 p로 몇 개의 이전 관측치를 고려할지를 결정한다. 
* MA (Moving Average): 이전 오차항들이 현재 관측치에 영향을 주는 모델이다. MA(1) 모델은 현재 관측치가 바로 이전의 오차항에 의해 영향을 받는다는 것을 나타냅니다. MA 모델은 파라미터 q로 몇 개의 이전 오차항을 고려할지를 결정한다.
* AR & MA 모델의 차이
AR(AutoRegressive) 모델과 MA(Moving Average) 모델은 둘 다 시계열 분석에서 널리 사용되는 모델이지만, 그 방식이 다르다.

1. AR 모델
* AR 모델은 ‘자기회귀 모델’ 로, 과거의 자신의 값에 의존하여 현재 값을 예측하는 방법을 사용한다. 즉, 이전 시점의 관측값이 현재 시점의 관측값에 영향을 줍니다.
* 예를 들어, 주식 시장에서 어제 주가가 상승했다면 오늘 주가도 상승할 가능성이 있다는 것 이 AR 모델의 관점이다.
#AR 모델은 파라미터 p로 이전 몇 개의 관측치를 고려할지 결정 하게 된다. AR(1) 모델은 바로 이전의 한 단계 관측치를 고려하고, AR(2) 모델은 바로 이전의 두 단계 관측치를 고려하게 된다.

(예시)
* 예를 들어, 전력 소비를 예측하는 문제를 생각해 보겠습니다. 사람들은 특정 시간대에 일관되게 전력을 사용하는 경향이 있다. 아침에 사람들이 일어나서 활동을 시작하면 전력 사용량이 증가하고, 밤에 사람들이 잠에 들면 전력 사용량이 감소한다. 이러한 경우, AR 모델은 이전 시간대의 전력 사용 패턴을 학습하여 다음 시간대의 전력 사용량을 예측하는 데 사용 될 수 있다.

2. MA 모델
* MA 모델은 ‘이동 평균 모델’ 로, 과거의 오차항에 의존하여 현재 값을 예측한다.
* 예를 들어, 우리가 날씨를 예측한다고 가정해 봅시다. 오늘의 기온 예측치가 실제 기온보다 더 높았다면, 이는 오차를 의미한다. MA 모델에 따르면, 이 오차는 내일의 기온 예측에 반영되어야 한다. 즉, 오늘 예측이 너무 높았다면, 내일의 예측치는 그 오차를 보정하기 위해 조금 더 낮아질 것이다.

## MA 모델은 파라미터 q로 이전 몇 개의 오차항을 고려할지 결정하게 된다. MA(1) 모델은 바로 이전의 한 단계 오차항 을 고려하고, MA(2) 모델은 바로 이전의 두 단계 오차항 을 고려하게 된다.

### 즉, AR 모델은 자신의 과거 값을, MA 모델은 과거의 예측 오차를 사용하여 현재 값을 예측하는 방법론이다. 어떤 모델을 사용할지는 주로 데이터의 특성과 목표에 따라 결정된다.

(예시)
* 매장의 판매량 예측을 예로 들어 보겠습니다. 이전의 판매 예측이 과소평가되었다면 (즉, 실제 판매량이 예측보다 높았다면), 그 다음날의 판매량 예측을 증가시키는 것이 합리적일 수 있다. 반대로, 이전의 판매 예측이 과대평가 되었다면 (즉, 실제 판매량이 예측보다 낮았다면), 그 다음날의 판매량 예측을 감소시키는 것이 합리적 일 수 있다. 이런 상황에서는 MA 모델이 유용하게 사용될 수 있다.

3. ARMA, ARIMA
* ARMA (AutoRegressive Moving Average): AR 모델과 MA 모델의 결합으로, 이전 관측치와 이전 오차항 모두를 고려하는 모델이다. ARMA 모델은 두 파라미터 p와 q를 모두 사용한다.
* ARIMA (AutoRegressive Integrated Moving Average): ARMA 모델에 비정상 시계열을 정상 시계열로 변환하는 과정을 포함한 모델이다. 이 변환 과정은 차분(differencing)이라고 하며, 몇 차 차분을 사용할지를 결정하는 파라미터가 d이다. 따라서 ARIMA 모델은 세 파라미터 p, d, q를 모두 사용한다.

## ARIMA 적용시 고려사항   # ARIMA모델만 쓰면 다른것도 가능
* AR(p) = ARIMA(p, 0, 0)
* MA(q) = ARIMA(0, 0, q)
* ARMA(p, q) = ARIMA(p, 0, q)

< SARIMAX > : 자주 사용함
SARIMAX: Seasonal AutoRegressive Integrated Moving Average with eXogenous regressors

## 주요 하이퍼파라미터
* AR(AutoRegressive): 이전 관측치의 값 을 사용하여 현재 값을 예측하는데 사용되는 모델이다.
* I(Integrated): 시계열의 비정상성을 처리하기 위해 사용되는 차분(Differencing) 단계를 나타냅니다.
* MA(Moving Average): 이전 오차항의 평균 을 사용하여 현재 값을 예측하는데 사용되는 모델이다.
* Seasonality: 계절성 요인 을 고려한 모델이다. 예를 들어, 연간 패턴, 월간 패턴, 주간 패턴 등을 모델링 할 수 있다.
* Exogenous: 시계열에 영향을 주는 외부 변수 를 고려하는 모델이다.

## ARIMA 모델은 AR, I, MA의 세 가지 구성요소만을 포함한다. 따라서 계절성과 외생변수는 ARIMA 모델로는 처리하기 어렵습니다. 이 때문에 이러한 요소를 고려해야 하는 복잡한 시계열 데이터를 분석할 때는 ARIMA 보다는 SARIMAX와 같은 확장된 모델 을 사용하는 것이 적합할 수 있다.
즉, ARIMA와 SARIMAX의 주요 차이점은 SARIMAX가 ARIMA에 비해 계절성 과 외생변수를 모델링할 수 있다는 점이다. 이로 인해 SARIMAX는 ARIMA보다 더 다양한 시계열 데이터를 분석할 수 있으며, 이에 따라 예측의 정확성을 높일 수 있다.

< 시계열 성분 분해 (Seasonal Decomposition) >
시계열 데이터 분석에서 성분 분해(Decomposition)는 관측된 시계열 데이터를 여러 성분으로 나누는 것을 의미한다. 이는 시계열 데이터에 있는 복잡한 패턴을 이해하고 분석하는 데 도움이 된다. 주로 데이터를 추세(Trend), 계절성(Seasonality), 그리고 잔차(Redisual)/불규칙성(Irregularity) 으로 분해한다.

* 추세 성분(Trend Component) : 이는 시계열 데이터의 장기적인 패턴 을 의미한다. 예를 들어, 회사의 매출이 시간이 지남에 따라 전반적으로 증가하거나 감소하는 경향이 있다면, 이를 추세라고 한다. 추세는 일반적으로 선형적일 수도 있고, 비선형적일 수도 있다.
* 계절 성분(Seasonal Component) : 이는 시계열 데이터에서 반복적으로 나타나는 패턴 을 의미한다. 예를 들어, 매년 여름에 아이스크림 판매가 증가하는 것이 계절성의 예이다. 계절성은 일반적으로 연간, 분기별, 월별, 주별, 일별 등 주기적으로 나타납니다.
* 불규칙 성분(Irregular Component) : 이는 추세나 계절성에 의해 설명되지 않는 잔차(Residual) 를 의미한다. 불규칙성은 랜덤 노이즈일 수도 있고, 데이터에 있는 예측 불가능한 변동성일 수도 있다. 예를 들어, 예측할 수 없는 이벤트(자연재해, 금융위기 등)에 의한 판매량의 변동이 이에 해당된다.

## additive 방식을 활용한 분해
* 시계열 데이터가 선형적인 형태 라는 가정하에 데이터를 분해한다.
* 즉, 데이터에서의 추세, 계절성, 그리고 잔차가 더해져 원래의 시계열 데이터를 구성한다는 가정이다.

## 이는 시계열 데이터의 계절적 효과가 시간이 흐름에 따라 일정하게 유지되는 경우에 적합한다.

